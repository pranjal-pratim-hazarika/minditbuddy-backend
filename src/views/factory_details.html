<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Factory Details</title>
    <link
      href="https://fonts.googleapis.com/css?family=Roboto"
      rel="stylesheet"/>
    <link
      href="https://fonts.googleapis.com/css?family=Poppins"
      rel="stylesheet"/>

    <link
      href="https://fonts.googleapis.com/css?family=Roboto"
      rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins"
      rel="stylesheet"/>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.12.0/css/mdb.min.css"
      rel="stylesheet"/>

    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300&display=swap"
      rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=Dosis&display=swap"
      rel="stylesheet"/>
    <link
      href="https://fonts.googleapis.com/css?family=Advent+Pro&display=swap"
      rel="stylesheet"/>
    <link
      href="https://fonts.googleapis.com/css?family=Play&display=swap"
      rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css?family=Cabin&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="factory_details.css" />
  </head>

  <body>
    <div class="st-div">
      <h5 class="st-head">Factory &nbsp Details</h5>
      <br />
    </div>

    <div class="container-fluid mb-5">
        <div style="float: left;margin-bottom: 0.5em;">

            <input type="text" id="factoryId" placeholder="Factory ID" onkeyup="searchByKeyup()"/>
            <button id="factorySearchBtn"  onclick="search()">
                <i class="fas fa-search" style="color: rgb(46, 156, 147);"></i>
            </button>
        </div>
        <div style="float: left;margin-bottom: 0.5em;">

          <input type="text" id="factoryName" placeholder="Factory Name" />
          <button id="factorySearchBtn"  onclick="searchByName()">
              <i class="fas fa-search" style="color: rgb(46, 156, 147);"></i>
          </button>
      </div>

      <div class="pageno-div"> Page  <span id="pageno"></span> 
          <input type="text" id="page" placeholder="Page No" />
          <button id="go-btn" onclick="go()">
              <i class="fas fa-search" style="color: rgb(46, 156, 147);"></i>
          </button> 
      </div>

      <table class="table table-striped table-light">
        <thead class="thead">
          <tr>
            <th scope="col">Sl No <i class="fas fa-list-ol"></i></th>
            <th scope="col">Factory Name <i class="fas fa-industry"></i></th>
            <th scope="col">Factory ID <i class="fas fa-key"></i></th>
            <th scope="col">
              Registration No <i class="fas fa-id-card-alt"></i>
            </th>
            <th scope="col">Aggregators <i class="fas fa-archive"></i></th>
            <th scope="col">Growers <i class="fab fa-envira"></i></th>
            <th scope="col">
              Growers Sale Through Aggregator
              <i class="fas fa-exchange-alt"></i>
            </th>
          </tr>
        </thead>
        <tbody id="data"></tbody>
      </table>
      <span id="info"></span>
      
      <button id="previous" onclick="loadPrev()">Previous</button>
      
      <button id="next" onclick="loadNext()">Next </button> <br><br>

      <div>
        <button id="initial" onclick="start()"><i class="fas fa-caret-left"></i> First</button>
        <button id="end" onclick="end()">Last <i class="fas fa-caret-right"></i></button>
      </div>

      <div id="totalCount">
        <i class="fas fa-info-circle"></i> Total Count:<span id="totalCountValue" style="margin-left: 0.5em;">0</span>
      </div>

    </div>
    
  
  <button id="logout" onclick="logout()">
    Logout
  </button>

  <link id="preLoad" rel="preload" href="http://192.168.1.6:3050/chaisahyog/api/v1/factories/?factory_id=&factory_name=&page=2" as="fetch" crossorigin="anonymous">

  <!-- ------------------------------------Script Logic----------------------------------------- -->

  <script>
    var page = 1;
    var jsonfile;
    var lastPage;
    var totalCount = function() {
      let token = JSON.parse(sessionStorage.getItem('myUniqueUserToken'));
      let url = "http://00251c5a.ngrok.io/chaisahyog/api/v1/factories/totalrecords/";
        let h = new Headers();
        h.append('Authorization', `Bearer ${token}`)
        let req = new Request(url, {
            method: 'GET',
            mode: 'cors',
            headers: h
        }); 
        fetch(req)
            .then(resp => resp.json())
            .then(data => {
             jsonfile = data; 
             document.getElementById("totalCountValue").innerHTML = jsonfile[0].totalRecords;
             lastPage = jsonfile[0].totalRecords;
            })
    }
    totalCount(); 

    var retrive = function(page) {
      let factoryId = document.getElementById("factoryId").value;
      let factoryName = document.getElementById("factoryName").value;
      document.getElementById("data").innerHTML = "";
      document.getElementById("info").innerHTML = "";
      
      let url = "http://00251c5a.ngrok.io/chaisahyog/api/v1/factories/?factory_id=" +
         factoryId + "&factory_name=" +
          factoryName +
         "&page=" +
          page;
        
        
        let token = JSON.parse(sessionStorage.getItem('myUniqueUserToken'));

        let h = new Headers();
        h.append('Authorization', `Bearer ${token}`)

        let req = new Request(url, {
            method: 'GET',
            mode: 'cors',
            headers: h
        });
         
        fetch(req)
            .then(resp => resp.json())
            .then(data => {
             jsonfile = data;

              if(jsonfile.success == false) {
                 document.location.href = "form.html";
              }
             
          // ----------------------------------------------Inserting Json Data To Table---------------------------------------------//
          if (jsonfile.length == 0) {
            
            document.getElementById("info").innerHTML =
              '<br><br> <tr><td colspan="7"><h3>No Records Found <i class="fas fa-search"></i> </h3></td></tr> <br><br>';
            document.getElementById("next").style.display = "none";
            document.getElementById("previous").style.display = "none";
          }
          else if(jsonfile.length < 10) {
            document.getElementById("next").disabled = true;
            document.getElementById("next").innerHTML = "No More Records!";
            document.getElementById("next").style.background = "none";
            document.getElementById("next").style.boxShadow = "none";
            document.getElementById("next").style.color = "#333";

            document.getElementById("next").style.display = "inline";
            document.getElementById("previous").style.display = "inline";
          } 
          else {
            document.getElementById("next").disabled = false;
            document.getElementById("next").innerHTML = "Next";
            document.getElementById("next").style.background = "rgb(46, 156, 147)";
            document.getElementById("next").style.boxShadow = "0 0 0 3px rgba(39, 167, 107, 0.212)";
            document.getElementById("next").style.color = "#f1f1f1";

            document.getElementById("next").style.display = "inline";
            document.getElementById("previous").style.display = "inline";
          }
          if (page == 1) {
            document.getElementById("previous").disabled = true;
            document.getElementById("previous").style.background = "grey";
          } else {
            document.getElementById("previous").disabled = false;
            document.getElementById("previous").style.background = "rgb(46, 156, 147)";
          }
          
          let slno = eval("(page * 10) - 9");
          for(let i = 0; i<jsonfile.length; i++) {
            let tableData =
              '<tr><td><span class="st-span">' +
              eval("slno + i") +
              '</span></td><td><span class="st-span-name">' +
              jsonfile[i].factory_name +
              '</span></td><td><span id="factory_id" class="st-span">' +
              jsonfile[i].factory_id +
              '</span></td><td><span id="rc_no" class="st-span">' +
              jsonfile[i].factory_rc_no +
              '</span></td>'+
              '<td><span id="aggregators" class="st-span"><a href="aggregator-details.html?link=' +
              jsonfile[i].links.aggregators +'&factory_name='+jsonfile[i].factory_name+'&factory_id='+jsonfile[i].factory_id+'&factory_rc_no='+jsonfile[i].factory_rc_no+
              '" target="_blank">View </a><i class="fas fa-link st-link"></i></span></td>'+
              '<td><span id="growers" class="st-span"><a href="grower-details.html?link=' +
              jsonfile[i].links.growers +'&factory_name='+jsonfile[i].factory_name+'&factory_id='+jsonfile[i].factory_id+'&factory_rc_no='+jsonfile[i].factory_rc_no+
              '" target="_blank">View </a><i class="fas fa-link st-link"></i></span></td><td><span id="growers_through_aggregator" class="st-span"><a href="grower-through-aggregator.html?link=' +
              jsonfile[i].links.growers_through_aggregator +'&factory_name='+jsonfile[i].factory_name+'&factory_id='+jsonfile[i].factory_id+'&factory_rc_no='+jsonfile[i].factory_rc_no+
              '" target="_blank">View </a><i class="fas fa-link st-link"></i></span></td></tr>'
            document.getElementById("data").innerHTML += tableData;
            document.getElementById("pageno").innerHTML = page;
            }
          })
            // .catch(err => {
            //     console.log(err.message);
            // })
       // -----------------------------End Insertion---------------------------//
       };

        
    var go = function() {
       if (document.getElementById("page").value < 1 || isNaN(document.getElementById("page").value)) {
         document.getElementById("info").innerHTML =
           '<br><tr><td colspan="7"><h3 id="invalid-pageno" >Invalid Page Number <i class="far fa-times-circle"></i> </h3></td></tr><br>';
         document.getElementById("page").value = "";
       } else {
         page = document.getElementById("page").value;
         retrive(page);
         document.getElementById("page").value = "";
       }



    };

    function searchByKeyup() {
      retrive(1);
    }

    var search =  function() {
      retrive(1);
      document.getElementById("factoryId").value = ""; 
      document.getElementById("factoryName").value = "";
    };
    var searchByName = function() {
      retrive(1);
      document.getElementById("factoryId").value = "";
      document.getElementById("factoryName").value = "";
    }
 

    var logout = function() {
      sessionStorage.clear();
      document.location.href = "form.html";
    };
     retrive(page);
     
     function loadNext() {
       let temp = page + 2;

      document.getElementById("preLoad").href = "http://192.168.1.6:3050/chaisahyog/api/v1/factories/?factory_id=&factory_name=&page="+eval(temp);
      retrive(++page);
     }

     function loadPrev() {
       let temp = page - 2;

       retrive(--page);

      if(temp != 0) {
        document.getElementById("preLoad").href = "http://192.168.1.6:3050/chaisahyog/api/v1/factories/?factory_id=&factory_name=&page="+eval(temp);
      }
     }

  function start() {
    retrive(1);
    page = 1;
  }

  function end(){
       let test = lastPage;
       let test1 = test / 10;
       let test2 = test % 10;
       let result = test1 - (test2 / 10);

       if(test2 == 0){
         retrive(result);
         page = result;
       } else {
        retrive(++ result);
        page = result;
       }
     }

  </script>
  <!-- -------------------------------E.O.Script---------------------- -->
</body>

</html>
